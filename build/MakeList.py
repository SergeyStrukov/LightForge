# MakeList.py
#
#   Simplex 1.00
#   Copyright 2022 (c) YADRO. All rights reserved. This is a private library.
#

import sys
import os

#-------------------------------------------------------------------------

class File:
    def __init__(self,path:str,name:str):
        self.path=path
        self.name=name
        self.noext=name[:-4];

#-------------------------------------------------------------------------

def join(path:str,file:str) -> str :
    if path=="." :
        return file;
    else:
        return path+"/"+file

def extend_list(file_list:[File],dir:str,prefix:str=''):
    print(prefix,"Source dir: ",dir,sep='')
    with os.scandir(dir) as it :
        for entry in it :
            if entry.is_file() :
                print(prefix,"  file: ",entry.name,sep='')
                if entry.name.endswith(".cpp") :
                    file_list.append(File(join(dir,entry.name),entry.name))
            else:
                extend_list(file_list,join(dir,entry.name),prefix+"  ")
    print(prefix,"-----",sep='')

#---------------------------------------------

file_list = []

for i in range(1,len(sys.argv)) :
    extend_list(file_list,sys.argv[i])

file_list.sort(key = lambda file: file.noext)

name_list = [file.noext for file in file_list]

for i in range(0,len(name_list)-1) :
    assert name_list[i] != name_list[i+1]

with open("Makefile-list", 'w') as f :
    print("# Makefile-list AUTOGENERATED, DON'T EDIT",file=f)
    print("",file=f)
    print("OBJ_LIST = \\",file=f)
    for file in file_list :
        print("$(OBJ_PATH)/{}.o \\".format(file.noext),file=f)
    print("",file=f)
    print("ASM_LIST = \\",file=f)
    for file in file_list :
        print("$(ASM_PATH)/{}.s \\".format(file.noext),file=f)
    print("",file=f)
    print("DEP_LIST = \\",file=f)
    for file in file_list :
        print("$(DEP_PATH)/{}.dep \\".format(file.noext),file=f)
    print("",file=f)
    print("#---------------------------------------------",file=f)

    for file in file_list :
        print("#",file.path,file=f)
        print("",file=f)
        print("$(OBJ_PATH)/{}.o : {} CC-opt.txt".format(file.noext,file.path),file=f)
        print("\t$(CC) $(CCOPT) @CC-opt.txt $< -o $@",file=f)
        print("",file=f)
        print("$(ASM_PATH)/{}.s : {} CC-opt.txt".format(file.noext,file.path),file=f)
        print("\t$(CC) -S $(CCOPT) @CC-opt.txt $< -o $@",file=f)
        print("",file=f)
        print("$(DEP_PATH)/{}.dep : {} CC-opt.txt".format(file.noext,file.path),file=f)
        print("\t$(CC) $(CCOPT) @CC-opt.txt -MM -MT $(OBJ_PATH)/{}.o $< -MF $@".format(file.noext),file=f)
        print("",file=f)

    print("include ../../../Makefile-tail",file=f)



